<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>แดชบอร์ด ANS Snooker 6-Red 2025 — Thai & Charts Fixed (Robust)</title>

  <!-- Tailwind (defer via onload trick to avoid blocking) -->
  <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
  <script src="https://cdn.tailwindcss.com" defer></script>

  <!-- Fonts: Preconnect + Thai subset -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap&subset=thai" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root { --thai-font: 'Sarabun','Tahoma','Noto Sans Thai',sans-serif; }
    html, body, * { font-family: var(--thai-font); }
    canvas, .chartjs-render-monitor { font-family: var(--thai-font) !important; }
    body { background: #f0f4f8; }
    .card { background:#fff; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,.1); }
    .error-banner {
      display:none; background:#fdecea; color:#b71c1c; border:1px solid #f5c6cb;
      padding:12px; border-radius:8px; margin-bottom:16px;
    }
    .ok-banner {
      display:none; background:#e8f5e9; color:#1b5e20; border:1px solid #c8e6c9;
      padding:12px; border-radius:8px; margin-bottom:16px;
    }
    /* Custom style for alternating table rows */
    .table-striped tbody tr:nth-child(odd) {
      background-color: #f9fafb;
    }
  </style>
</head>
<body class="p-8">
  <div class="max-w-7xl mx-auto">
    <div id="errorBanner" class="error-banner"></div>
    <div id="okBanner" class="ok-banner"></div>

    <h1 class="text-4xl font-bold text-gray-800 text-center mb-12">
      <i class="fas fa-chart-line text-blue-600 mr-3"></i> การแข่งขัน ANS Snooker 6-Red 2025
    </h1>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
      <div class="card p-6 flex items-center justify-between">
        <div>
          <div class="text-sm text-gray-500">จำนวนนักกีฬาทั้งหมด</div>
          <div id="totalPlayers" class="text-4xl font-bold text-gray-900 mt-2">0</div>
        </div>
        <div class="p-3 bg-blue-100 rounded-full">
          <i class="fas fa-users text-blue-600 text-3xl"></i>
        </div>
      </div>

      <div class="card p-6 flex items-center justify-between">
        <div>
          <div class="text-sm text-gray-500">นักกีฬาที่โอนเงินแล้ว</div>
          <div id="transferCount" class="text-4xl font-bold text-gray-900 mt-2">0</div>
        </div>
        <div class="p-3 bg-yellow-100 rounded-full">
          <i class="fas fa-check-circle text-yellow-600 text-3xl"></i>
        </div>
      </div>

      <div class="card p-6 flex items-center justify-between">
        <div>
          <div class="text-sm text-gray-500">นักกีฬาที่ยังไม่ได้โอนเงิน</div>
          <div id="noTransferCount" class="text-4xl font-bold text-gray-900 mt-2">0</div>
        </div>
        <div class="p-3 bg-red-100 rounded-full">
          <i class="fas fa-times-circle text-red-600 text-3xl"></i>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-1 gap-6">
      <div class="card p-6 flex flex-col items-center">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
          <i class="fas fa-chart-bar text-pink-500 mr-2"></i> จำนวนนักกีฬาแบ่งตามรุ่น
        </h2>
        <div class="flex items-center justify-center w-full">
          <canvas id="ageGroupChart" class="w-full" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="mt-8 card p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">
        <i class="fas fa-table text-gray-600 mr-2"></i> ข้อมูลนักกีฬาทั้งหมด
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8">
        <!-- Top Left Table -->
        <div class="overflow-x-auto">
          <h3 class="text-lg font-bold text-gray-700 mb-2">ลำดับ 1 - 16</h3>
          <table class="min-w-full divide-y divide-gray-200 table-striped">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ลำดับ</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ชื่อและรุ่น</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">สถานะโอนเงิน</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ขนาดเสื้อ</th>
              </tr>
            </thead>
            <tbody id="playerTableBody1" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>

        <!-- Top Right Table -->
        <div class="overflow-x-auto">
          <h3 class="text-lg font-bold text-gray-700 mb-2">ลำดับ 17 - 32</h3>
          <table class="min-w-full divide-y divide-gray-200 table-striped">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ลำดับ</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ชื่อและรุ่น</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">สถานะโอนเงิน</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ขนาดเสื้อ</th>
              </tr>
            </thead>
            <tbody id="playerTableBody2" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>

        <!-- Bottom Left Table -->
        <div class="overflow-x-auto">
          <h3 class="text-lg font-bold text-gray-700 mb-2">ลำดับ 33 - 48</h3>
          <table class="min-w-full divide-y divide-gray-200 table-striped">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ลำดับ</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ชื่อและรุ่น</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">สถานะโอนเงิน</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ขนาดเสื้อ</th>
              </tr>
            </thead>
            <tbody id="playerTableBody3" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>

        <!-- Bottom Right Table -->
        <div class="overflow-x-auto">
          <h3 class="text-lg font-bold text-gray-700 mb-2">ลำดับ 49 - 64</h3>
          <table class="min-w-full divide-y divide-gray-200 table-striped">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ลำดับ</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ชื่อและรุ่น</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">สถานะโอนเงิน</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ขนาดเสื้อ</th>
              </tr>
            </thead>
            <tbody id="playerTableBody4" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Primary CDN for Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer onerror="window.__chartCdnError=true;"></script>
  <!-- Chart.js Datalabels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0" defer></script>

  <script>
    // Multi-CDN fallback loader for Chart.js
    (function() {
      const cdns = [
        "https://cdn.jsdelivr.net/npm/chart.js",
        "https://unpkg.com/chart.js@latest/dist/chart.umd.js",
        "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"
      ];
      let idx = 0;

      function loadNext() {
        if (window.Chart) return; // already loaded
        if (idx >= cdns.length) {
          showError("ไม่สามารถโหลดไลบรารี Chart.js ได้จาก CDN ทั้งหมด");
          return;
        }
        const src = cdns[idx++];
        const s = document.createElement("script");
        s.src = src;
        s.defer = true;
        s.onload = () => {
          if (window.Chart) {
            okMsg("โหลด Chart.js จาก CDN สำรองสำเร็จ");
            initDashboard();
          } else {
            loadNext();
          }
        };
        s.onerror = () => loadNext();
        document.head.appendChild(s);
      }

      // If first CDN failed or Chart not present after DOMContentLoaded, try fallbacks
      window.addEventListener("DOMContentLoaded", () => {
        setTimeout(() => {
          if (!window.Chart) loadNext();
          else initDashboard();
        }, 200); // small delay to allow primary script to execute
      });

      function showError(msg) {
        const el = document.getElementById("errorBanner");
        if (el) { el.textContent = `⚠️ ${msg}`; el.style.display = "block"; }
      }
      function okMsg(msg) {
        const el = document.getElementById("okBanner");
        if (el) { el.textContent = `✅ ${msg}`; el.style.display = "block"; }
      }

      async function initDashboard() {
        try {
          // Wait for fonts (avoid tofu on axes/legends)
          if (document.fonts && document.fonts.ready) await document.fonts.ready;

          const thaiFont = getComputedStyle(document.documentElement)
              .getPropertyValue('--thai-font').replace(/['"]/g,'').trim();
          if (thaiFont && window.Chart) Chart.defaults.font.family = thaiFont;

          const csv = `ลำดับ,ชื่อ,รุ่น,แฮนดิแคป,โอน,size,,,
1,ไก่,39,20,อล.,L,,,,,,
2,สุวัฒน์,41,14,อล.,L,,,,,,
3,หนุ่ย,42,10,อล.,L,,,,,,
4,ฉัตร,43,14,อล.,L,,,,,,
5,โชค,43,10,อล.,2XL,,,,,,
6,ป๊อด,45,5,อล.,2XL,,,,,,
7,โด๊ะ,46,10,อล.,L,,,,,,
8,กอ,47,10,อล.,3XL,,,,,,
9,พุ่ม,47,10,อล.,XL,,,,,,
10,แจ้,47,20,อล.,3XL,,,,,,
11,พงศ์,47,14,อล.,2XL,,,,,,
12,ตุ๊ก,48,10,อล.,3XL,,,,,,
13,วัตร,48,10,อล.,M,,,,,,
14,สกล,48,12,,L,,,,,,
15,โชค,49,14,,L,,,,,,
16,ตือ,49,20,,XL,,,,,,
17,อ้อ,49,12,,XL,,,,,,
18,เม้ง,49,14,อล.,M,,,,,,
19,กรณ์,50,10,,L,,,,,,
20,ดิ๊ก,50,14,อล.,XL,,,,,,
21,ซิ,50,14,,L,,,,,,
22,โจ้,50,10,,XL,,,,,,
23,เจี๊ยบ,51,14,,XL,,,,,,
24,โดม,51,14,,L,,,,,,
25,ดำ,52,10,,L,,,,,,
26,ชาย,53,10,,L,,,,,,
27,เจี๊ยบ,54,5,,3XL,,,,,,
28,ปู๊ด,54,10,,3XL,,,,,,
29,ต่อง,55,5,อล.,XL,,,,,,
30,เล็ก,55,10,,L,,,,,,
31,ต้อย,56,10,,L,,,,,,
32,เอ๋,56,,,L,,,,,,
33,ติ,57,7,,XL,,,,,,
34,อู,57,10,,L,,,,,,
35,เล็ก,57,7,,2XL,,,,,,
36,ชิต,57,,,2XL,,,,,,
37,พร้อม,58,10,อล.,L,,,,,,
38,มะนาว,58,12,,L,,,,,,
39,อุ้ย,58,12,,L,,,,,,
40,ต๊อบ,58,12,,2XL,,,,,,
41,อาท,58,12,,L,,,,,,
42,ตี๋,58,5,,3XL,,,,,,
43,ก้อย,58,12,,5XL,,,,,,
44,กร,58,10,อล.,L,,,,,,
45,ชัย,58,12,อล.,XL,,,,,,
46,วีณ,61,0,อล.,XL,,,,,,
47,ต้น,61,10,อล.,3XL,,,,,,
48,ต่อ,62,5,,L,,,,,,
49,เสริฐ,62,7,อล.,L,,,,,,
50,ดิษ,62,10,อล.,L,,,,,,
51,ไก่,62,10,,4XL,,,,,,
52,แบน,62,10,,M,,,,,,
53,หมู,62,2,อล.,XL,,,,,,
54,หนุ่ม,63,7,อล.,L,,,,,,
55,นุ,63,5,,3XL,,,,,,
56,เอก,65,0,,XL,,,,,,
57,แหย,65,7,,L,,,,,,
58,เขต,65,10,,4XL,,,,,,
59,ก้อง,65,7,,XL,,,,,,
60,สิงหา,67,5,อล.,2XL,,,,,,
61,อู๋,67,10,อล.,2XL,,,,,,
62,ณัฐ,67,10,,อก58,,,,,,
63,วัฒน์,68,0,,2XL,,,,,,
64,แดง,No.9,12,,5XL,,,,,,
`.trim();

          const players = csv.split('\n').slice(1).map(row => {
            const c = row.split(',');
            const ageRaw = (c[2] || '').trim();
            const ageNum = parseInt(ageRaw, 10);
            const age = Number.isNaN(ageNum) ? (ageRaw || '') : ageNum;
            return {
              id: (c[0]||'').trim(),
              name: (c[1]||'').trim(),
              age,
              handicap: (c[3]||'').trim(),
              transfer: (c[4]||'').trim() === 'อล.',
              size: (c[5]||'').trim()
            };
          }).filter(p => p.name);

          // Cards
          const total = players.length;
          const paid = players.filter(p => p.transfer).length;
          const unpaid = total - paid;
          document.getElementById('totalPlayers').textContent = total;
          document.getElementById('transferCount').textContent = paid;
          document.getElementById('noTransferCount').textContent = unpaid;

          // Grouping
          const ageMap = {};
          const sizeMap = {};
          for (const p of players) {
            if (p.age !== '' && p.age !== undefined && p.age !== null) {
              ageMap[p.age] = (ageMap[p.age] || 0) + 1;
            }
            if (p.size) sizeMap[p.size] = (sizeMap[p.size] || 0) + 1;
          }
          const ageKeys = Object.keys(ageMap).sort((a,b)=>{
            const na=parseInt(a,10), nb=parseInt(b,10);
            const aN=!Number.isNaN(na), bN=!Number.isNaN(nb);
            if (aN && bN) return na-nb;
            if (aN) return -1;
            if (bN) return 1;
            return a.localeCompare(b,'th');
          });

          // Brighter Colors for charts
          const pinks = ['#FF69B4', '#FF1493', '#C71585', '#DB7093', '#FFB6C1', '#EE82EE', '#DA70D6'];
          const purples = ['#9370DB', '#8A2BE2', '#4B0082', '#6A5ACD', '#800080', '#BA55D3', '#DDA0DD'];
          const combinedColors = [];
          for (let i = 0; i < Math.max(pinks.length, purples.length); i++) {
              if (i < pinks.length) combinedColors.push(pinks[i]);
              if (i < purples.length) combinedColors.push(purples[i]);
          }

          // Vertical Bar Chart for Age Groups
          const ageCtx = document.getElementById('ageGroupChart');
          new Chart(ageCtx, {
            type:'bar',
            data:{
              labels: ageKeys.map(k => `รุ่น ${k}`),
              datasets:[{
                label:'จำนวนนักกีฬา',
                data: ageKeys.map(k=>ageMap[k]),
                backgroundColor: combinedColors,
                borderColor: combinedColors,
                borderWidth: 1,
                borderRadius: 8
              }]
            },
            options:{
              responsive:true,
              scales:{
                x:{ beginAtZero:true, ticks:{ stepSize:1 }, grid: { display: false } } ,
                y:{ grid: { display: true } }
              },
              plugins: {
                legend: { display: false },
                datalabels: {
                  anchor: 'end',
                  align: 'top',
                  formatter: (value) => value,
                  color: '#555',
                  font: { weight: 'bold' }
                }
              }
            },
            plugins: [ChartDataLabels]
          });

          // Table
          const tableBodies = [
            document.getElementById('playerTableBody1'),
            document.getElementById('playerTableBody2'),
            document.getElementById('playerTableBody3'),
            document.getElementById('playerTableBody4'),
          ];
          
          const playerChunks = [
            players.slice(0, 16),
            players.slice(16, 32),
            players.slice(32, 48),
            players.slice(48, 64)
          ];

          for (let i = 0; i < tableBodies.length; i++) {
              const tableBody = tableBodies[i];
              const chunk = playerChunks[i];
              tableBody.innerHTML = ''; // Clear previous content
              chunk.forEach(p => {
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-gray-100');
                tr.innerHTML = `
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.id}</td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-base font-semibold text-gray-900">${p.name} (${p.age}) <span class="text-sm font-normal text-red-500">${p.handicap ? `+${p.handicap}` : ''}</span></div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${p.transfer ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                      ${p.transfer ? 'โอนแล้ว' : 'ยังไม่โอน'}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.size || '-'}</td>
                `;
                tableBody.appendChild(tr);
              });
          }

        } catch (e) {
          const el = document.getElementById("errorBanner");
          if (el) { el.textContent = "⚠️ เกิดข้อผิดพลาดในการเริ่มระบบกราฟ: " + (e && e.message ? e.message : e); el.style.display = "block"; }
          console.error(e);
        }
      }
      window.initDashboard = initDashboard;
    })();
  </script>
</body>
</html>
